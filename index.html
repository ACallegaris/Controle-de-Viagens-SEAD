<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Controle de Viagens - SEAD</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    td[contenteditable="true"] { background-color: #ffffdd; }
    .status-ACONTECENDO { background-color: #fff3cd; }
    .status-A\ INICIAR { background-color: #d1ecf1; }
    .status-ENCERRADO { background-color: #d4edda; }
    #formNovaViagem input, #formNovaViagem select { margin: 4px; }
  </style>
</head>
<body>
  <h2>Controle de Viagens - SEAD</h2>

  <button id="novaViagemBtn">+ Nova Viagem</button>
  <div id="formNovaViagem" style="display:none; margin-top: 10px;">
    <input type="text" placeholder="DATA DE IDA (DD/MM/AAAA)" id="dataIda">
    <input type="text" placeholder="DATA DO RETORNO (DD/MM/AAAA)" id="dataRetorno">
    <input type="text" placeholder="SOLICITANTE" id="solicitante">
    <input type="text" placeholder="DESTINO" id="destino">
    <input type="text" placeholder="MOTORISTA" id="motorista">
    <input type="text" placeholder="CARRO" id="carro">
    <input type="text" placeholder="PLACA" id="placa">
    <!-- O campo de seleção de status foi removido, pois o status será calculado automaticamente -->
    <button onclick="adicionarViagem()">Adicionar</button>
  </div>

  <table id="viagens" class="display" style="width:100%">
    <thead></thead>
    <tbody></tbody>
  </table>

  <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>

  <script>
// Mock data for initial table population
const viagensData = [
  {
    "DATA DE IDA": "2025-07-03",
    "DATA DO RETORNO": "2025-07-18",
    "SOLICITANTE": "kayo/SPI",
    "DESTINO": "Territorio vale do itaim",
    "MOTORISTA": "Almir",
    "CARRO": "S-10",
    "PLACA": "QRW4J55",
    "STATUS DA VIAGEM": "ACONTECENDO"
  },
  {
    "DATA DE IDA": "2025-07-08",
    "DATA DO RETORNO": "2025-07-11",
    "SOLICITANTE": "Victoria/SPI",
    "DESTINO": "Parnaiba-PI",
    "MOTORISTA": "Antonio",
    "CARRO": "S-10",
    "PLACA": "",
    "STATUS DA VIAGEM": "A INICIAR"
  },
  {
    "DATA DE IDA": "2025-07-10",
    "DATA DO RETORNO": "2025-07-23",
    "SOLICITANTE": "kayo/SPI",
    "DESTINO": "Territorio chapada das mangabeiras",
    "MOTORISTA": "Ricardo",
    "CARRO": "S-10",
    "PLACA": "",
    "STATUS DA VIAGEM": "A INICIAR"
  },
  {
    "DATA DE IDA": "2025-06-30",
    "DATA DO RETORNO": "2025-07-04",
    "SOLICITANTE": "Thays/CIASP",
    "DESTINO": "Parnaiba-PI, Picos e Floriano",
    "MOTORISTA": "Ricardo",
    "CARRO": "A-10",
    "PLACA": "QRW8I99",
    "STATUS DA VIAGEM": "ENCERRADO"
  },
  {
    "DATA DE IDA": "2025-07-07",
    "DATA DO RETORNO": "2025-07-14",
    "SOLICITANTE": "kayo/SPI",
    "DESTINO": "Padre Marcos e Paulistana - PI",
    "MOTORISTA": "Emerson",
    "CARRO": "S-10",
    "PLACA": "",
    "STATUS DA VIAGEM": "ACONTECENDO"
  }
];

let table; // Global variable to hold the DataTable instance

// Helper function to convert ISO-MM-DD to DD/MM/YYYY
function formatDateToBR(dateString) {
  if (!dateString) return "";
  const [year, month, day] = dateString.split('-');
  return `${day}/${month}/${year}`;
}

// Helper function to convert DD/MM/YYYY to ISO-MM-DD
function formatDateToISO(dateString) {
  if (!dateString) return "";
  const parts = dateString.split('/');
  if (parts.length === 3) {
    const [day, month, year] = parts;
    return `${year}-${month}-${day}`;
  }
  return dateString; // Return as is if not in DD/MM/YYYY format
}

// Function to determine trip status based on dates
function getTripStatus(dataIdaISO, dataRetornoISO) {
  const today = new Date();
  today.setHours(0, 0, 0, 0); // Normalize to start of day

  const idaDate = new Date(dataIdaISO);
  idaDate.setHours(0, 0, 0, 0);

  const retornoDate = new Date(dataRetornoISO);
  retornoDate.setHours(0, 0, 0, 0);

  if (today < idaDate) {
    return "A INICIAR";
  } else if (today >= idaDate && today <= retornoDate) {
    return "ACONTECENDO";
  } else {
    return "ENCERRADO";
  }
}

$(document).ready(function () {
  // Define base columns from data keys
  const baseColumns = Object.keys(viagensData[0]).map(col => {
    if (col.startsWith("DATA")) {
      return {
        title: col,
        data: col,
        render: function(data, type, row) {
          if (type === 'display' || type === 'filter') {
            return formatDateToBR(data);
          }
          return data;
        }
      };
    }
    return {
      title: col,
      data: col
    };
  });

  // Add the "Ações" column for the delete button
  const columnsWithActions = [...baseColumns, {
    title: "Ações",
    data: null, // No direct data source
    orderable: false,
    searchable: false,
    render: function(data, type, row) {
      // Button for deleting a row
      return `<button class="delete-btn px-3 py-1 bg-red-500 text-white rounded-md hover:bg-red-600 transition duration-200 text-xs">Excluir</button>`;
    }
  }];

  table = $('#viagens').DataTable({
    data: viagensData,
    columns: columnsWithActions, // Use columns with the "Ações" column
    dom: 'Bfrtip',
    buttons: [
      {
        extend: 'csvHtml5',
        text: 'Exportar CSV',
        filename: 'relatorio_viagens',
        exportOptions: {
          columns: ':not(:last-child)', // Exclude the last column (Ações) from export
          format: {
            body: function (data, row, column, node) {
              // Convert dates back to ISO-MM-DD for CSV export if they are date columns
              const columnTitle = table.column(column).header().textContent;
              if (columnTitle.startsWith("DATA")) {
                return formatDateToISO(data); // Ensure ISO format for CSV
              }
              return data;
            }
          }
        }
      },
      {
        extend: 'excelHtml5',
        text: 'Exportar Excel',
        filename: 'relatorio_viagens',
        exportOptions: {
          columns: ':not(:last-child)', // Exclude the last column (Ações) from export
          format: {
            body: function (data, row, column, node) {
              // Convert dates back to ISO-MM-DD for Excel export if they are date columns
              const columnTitle = table.column(column).header().textContent;
              if (columnTitle.startsWith("DATA")) {
                return formatDateToISO(data); // Ensure ISO format for Excel
              }
              return data;
            }
          }
        }
      }
    ],
    createdRow: function(row, data) {
      // Apply status class to the correct column (index 7 for STATUS DA VIAGEM)
      if (data["STATUS DA VIAGEM"]) {
        const statusClass = "status-" + data["STATUS DA VIAGEM"].replaceAll(" ", "\\ ");
        $('td', row).eq(7).addClass(statusClass);
      }
    }
  });

  // Event listener for cell editing
  $('#viagens tbody').on('click', 'td', function () {
    const cell = table.cell(this);
    const columnIndex = cell.index().column;
    const columnTitle = table.column(columnIndex).header().textContent;

    // Prevent editing the "Ações" column or "STATUS DA VIAGEM" column
    if (columnTitle === "Ações" || columnTitle === "STATUS DA VIAGEM") {
        return;
    }

    let original = cell.data();

    // Convert date from ISO to BR format for editing if it's a date column
    if (columnTitle.startsWith("DATA")) {
      original = formatDateToBR(original);
    }

    $(this).attr('contenteditable', true).focus();
    $(this).text(original); // Display the BR formatted date for editing

    $(this).on('blur', function () {
      let newVal = $(this).text();

      // Convert date from BR to ISO format for saving if it's a date column
      if (columnTitle.startsWith("DATA")) {
        newVal = formatDateToISO(newVal);
      }

      // Get the row data to re-evaluate status if dates are changed
      const rowData = table.row($(this).parents('tr')).data();
      let updatedRowData = { ...rowData }; // Create a copy

      // Update the specific field that was edited
      updatedRowData[columnTitle] = newVal;

      // If a date column was edited, re-calculate the status
      if (columnTitle.startsWith("DATA")) {
          updatedRowData["STATUS DA VIAGEM"] = getTripStatus(
              updatedRowData["DATA DE IDA"],
              updatedRowData["DATA DO RETORNO"]
          );
      }

      // Check if the new value is different from the original (ISO format for comparison)
      if (newVal !== cell.data() || columnTitle.startsWith("DATA")) { // Re-draw if date changed to update status
        cell.data(newVal).draw(); // Update the edited cell
        // Update the status cell explicitly if a date was changed
        if (columnTitle.startsWith("DATA")) {
            table.cell(cell.index().row, 7).data(updatedRowData["STATUS DA VIAGEM"]).draw();
        }
        saveTable(table); // Save changes to localStorage
      }
      $(this).removeAttr('contenteditable');
    });
  });

  // Event listener for delete button click
  $('#viagens tbody').on('click', '.delete-btn', function () {
    const row = table.row($(this).parents('tr'));
    const rowData = row.data(); // Get the data for the row being deleted

    // Confirmation dialog before deleting
    if (confirm(`Tem certeza que deseja excluir a viagem para ${rowData.DESTINO} de ${formatDateToBR(rowData["DATA DE IDA"])}?`)) {
        row.remove().draw(); // Remove from DataTables
        saveTable(table); // Save updated data to localStorage
    }
  });

  loadTable(table); // Load and process initial data
  document.getElementById('novaViagemBtn').onclick = () => {
    const form = document.getElementById('formNovaViagem');
    form.style.display = form.style.display === 'none' ? 'block' : 'none';
  };
});

function adicionarViagem() {
  const dataIdaBr = document.getElementById('dataIda').value;
  const dataRetornoBr = document.getElementById('dataRetorno').value;

  const dataIdaISO = formatDateToISO(dataIdaBr);
  const dataRetornoISO = formatDateToISO(dataRetornoBr);

  const statusCalculado = getTripStatus(dataIdaISO, dataRetornoISO);

  const nova = {
    "DATA DE IDA": dataIdaISO,
    "DATA DO RETORNO": dataRetornoISO,
    "SOLICITANTE": document.getElementById('solicitante').value,
    "DESTINO": document.getElementById('destino').value,
    "MOTORISTA": document.getElementById('motorista').value,
    "CARRO": document.getElementById('carro').value,
    "PLACA": document.getElementById('placa').value,
    "STATUS DA VIAGEM": statusCalculado // Status é definido automaticamente
  };

  table.row.add(nova).draw();
  saveTable(table);

  document.querySelectorAll('#formNovaViagem input').forEach(input => input.value = "");
  document.getElementById('formNovaViagem').style.display = 'none';
}

function saveTable(table) {
  const data = table.rows().data().toArray();
  localStorage.setItem("viagensData", JSON.stringify(data));
}

function loadTable(table) {
  const savedData = localStorage.getItem("viagensData");
  if (savedData) {
    let data = JSON.parse(savedData);
    // Re-evaluate status for all loaded trips
    data = data.map(trip => {
      const status = getTripStatus(trip["DATA DE IDA"], trip["DATA DO RETORNO"]);
      return { ...trip, "STATUS DA VIAGEM": status };
    });
    table.clear().rows.add(data).draw();
  }
}
  </script>
</body>
</html>
